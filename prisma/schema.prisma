// prisma/schema.prisma
// ETICA - Schéma aligné sur la méthodologie (12 domaines, 5 familles, maturité 0-4)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTIFICATION (NE PAS MODIFIER)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?
  image         String?
  role          UserRole  @default(VIEWER)

  ownedSias       Sia[]
  memberships     SiaMember[]
  assignedActions Action[]
  arbitrations    Arbitration[]

  accounts      Account[]
  sessions      Session[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  ADMIN
  OWNER
  CONTRIBUTOR
  REVIEWER
  VIEWER
}

// ============================================
// SIA - Système d'Intelligence Artificielle
// ============================================

model Sia {
  id          String    @id @default(cuid())

  // Identité
  name        String
  description String?   @db.Text
  sector      Sector    @default(OTHER)  // Renommé de "domain"
  status      SiaStatus @default(DRAFT)

  // Finalité
  finalPurpose    String?   @db.Text

  // Contexte d'usage
  usageFrequency  Frequency @default(ON_DEMAND)
  userScale       Scale     @default(SMALL)  // Renommé de "scale"
  geographicScope String[]

  // Cadrage (CONSERVER - utilisés dans le code existant)
  decisionType    DecisionType @default(INFORMATIVE)
  dataTypes       String[]
  populations     String[]
  hasVulnerable   Boolean   @default(false)

  // Parties prenantes
  stakeholders    Json?
  misuseScenarios String[]

  // Dépendances externes
  hasExternalAI     Boolean   @default(false)
  hasExternalInfra  Boolean   @default(false)
  externalProviders String[]

  // Propriétaire
  ownerId     String
  owner       User      @relation(fields: [ownerId], references: [id])

  // Relations
  members     SiaMember[]
  nodes       Node[]
  edges       Edge[]
  tensions    Tension[]
  actions     Action[]
  versions    Version[]

  // Scores de vigilance calculés (cache)
  vigilanceScores Json?
  globalScore     Float?

  // Dates
  nextReviewDate DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([ownerId])
}

model SiaMember {
  id     String   @id @default(cuid())
  siaId  String
  sia    Sia      @relation(fields: [siaId], references: [id], onDelete: Cascade)
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   UserRole @default(VIEWER)

  createdAt DateTime @default(now())

  @@unique([siaId, userId])
}

// ============================================
// ENUMS PRINCIPAUX
// ============================================

enum Sector {
  HEALTH
  FINANCE
  HR
  COMMERCE
  JUSTICE
  ADMINISTRATION
  EDUCATION
  TRANSPORT
  INSURANCE
  SECURITY
  MARKETING
  OTHER
}

enum SiaStatus {
  DRAFT
  ACTIVE
  REVIEW
  ARCHIVED
}

enum DecisionType {
  INFORMATIVE
  RECOMMENDATION
  ASSISTED_DECISION
  AUTO_DECISION
}

enum Scale {
  TINY
  SMALL
  MEDIUM
  LARGE
  VERY_LARGE
}

enum Frequency {
  REALTIME
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  ON_DEMAND
  ONE_TIME
}

// ============================================
// LES 12 DOMAINES ÉTHIQUES
// ============================================

enum EthicalDomain {
  // Cercle 1 : Les Personnes
  PRIVACY
  EQUITY
  TRANSPARENCY
  AUTONOMY
  SECURITY
  RECOURSE

  // Cercle 2 : L'Organisation
  MASTERY
  RESPONSIBILITY
  SOVEREIGNTY

  // Cercle 3 : La Société
  SUSTAINABILITY
  LOYALTY
  SOCIETAL_BALANCE
}

// ============================================
// NOEUDS (Blocs du graphe)
// ============================================

model Node {
  id     String   @id @default(cuid())
  siaId  String
  sia    Sia      @relation(fields: [siaId], references: [id], onDelete: Cascade)

  type    NodeType
  subtype String?
  label   String

  positionX  Float  @default(0)
  positionY  Float  @default(0)

  // Annotation des domaines
  reinforcesDomains EthicalDomain[]
  affectsDomains    EthicalDomain[]

  attributes Json @default("{}")

  outgoingEdges Edge[] @relation("EdgeSource")
  incomingEdges Edge[] @relation("EdgeTarget")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siaId])
}

enum NodeType {
  HUMAN
  AI
  INFRA
  ORG
}

// ============================================
// FLUX (Liens entre blocs)
// ============================================

model Edge {
  id       String @id @default(cuid())
  siaId    String
  sia      Sia    @relation(fields: [siaId], references: [id], onDelete: Cascade)

  sourceId String
  source   Node   @relation("EdgeSource", fields: [sourceId], references: [id], onDelete: Cascade)
  targetId String
  target   Node   @relation("EdgeTarget", fields: [targetId], references: [id], onDelete: Cascade)

  label    String?

  direction FlowDirection
  nature    FlowNature

  intent    FlowIntent    @default(INFORMATION)
  channel   FlowChannel   @default(API)

  dataCategories DataCategory[]
  sensitivity    Sensitivity     @default(STANDARD)
  automation     AutomationLevel @default(INFORMATIVE)

  isReversible   Boolean         @default(true)

  criticality    FlowCriticality @default(IMPORTANT)
  frequency      Frequency       @default(ON_DEMAND)
  legalBasis     LegalBasis?

  // Profil éthique (5 dimensions, 1-5 chacune) - CONSERVER pour compatibilité
  agentivity      Int?
  asymmetry       Int?
  irreversibility Int?
  scalability     Int?
  opacity         Int?

  ethicalProfileScore Float?
  vigilanceLevel Int?

  tensionEdges TensionEdge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siaId])
  @@index([sourceId])
  @@index([targetId])
}

enum FlowDirection {
  H2M
  M2M
  M2H
  H2H
}

enum FlowNature {
  COLLECT
  INFERENCE
  ENRICHMENT
  DECISION
  RECOMMENDATION
  NOTIFICATION
  LEARNING
  CONTROL
  TRANSFER
  STORAGE
}

enum FlowIntent {
  COMMAND
  FEEDBACK
  SURVEILLANCE
  INFORMATION
  EVALUATION
  TRAINING
  QUERY
}

enum FlowChannel {
  API
  USER_INTERFACE
  SENSOR
  NOTIFICATION
  BATCH_PROCESS
  WEBHOOK
  FILE_TRANSFER
}

enum DataCategory {
  IDENTIFIER
  DEMOGRAPHIC
  LOCATION
  FINANCIAL
  HEALTH
  BIOMETRIC
  BEHAVIORAL
  PROFESSIONAL
  OPINION
  JUDICIAL
  INFERRED
  CONTENT
  TECHNICAL
  OTHER
}

enum Sensitivity {
  STANDARD
  SENSITIVE
  HIGHLY_SENSITIVE
}

enum AutomationLevel {
  INFORMATIVE
  ASSISTED
  SEMI_AUTO
  AUTO_WITH_RECOURSE
  AUTO_NO_RECOURSE
}

enum FlowCriticality {
  ACCESSORY
  IMPORTANT
  CRITICAL
}

enum LegalBasis {
  CONSENT
  CONTRACT
  LEGAL_OBLIGATION
  VITAL_INTEREST
  PUBLIC_INTEREST
  LEGITIMATE_INTEREST
}

// ============================================
// TENSIONS / DILEMMES ÉTHIQUES
// ============================================

model Tension {
  id     String @id @default(cuid())
  siaId  String
  sia    Sia    @relation(fields: [siaId], references: [id], onDelete: Cascade)

  // Domaines en tension (NOUVEAU)
  domainA EthicalDomain?
  domainB EthicalDomain?

  // Règle de détection (NOUVEAU)
  ruleId     String?
  ruleName   String?
  ruleFamily RuleFamily?

  // Description
  formulation String? @db.Text
  mechanism   String? @db.Text

  // CONSERVER pour compatibilité avec code existant
  pattern         TensionPattern?
  customTitle     String?
  description     String?          @db.Text
  impactedDomains String[]
  triggeredByRule String?

  // Flux concernés
  affectedNodeIds String[]
  affectedEdgeIds String[]
  tensionEdges    TensionEdge[]

  // Qualification
  severity            Int      @default(3)
  probability         Int?
  vulnerability       Int?
  detectability       Int?
  aggravatingFactors  String[]
  mitigatingFactors   String[]

  // Guidance
  questionsToConsider    String[]
  stakeholdersToConsult  String[]
  acceptablePatterns     String[]
  requiredEvidences      String[]

  status TensionStatus @default(DETECTED)

  // Maturité 0-4
  maturity Int @default(0)

  // Scores calculés - CONSERVER
  exposureScore  Float?
  coverageScore  Float?
  residualScore  Float?

  // Relations
  arbitrations Arbitration[]
  actions      Action[]

  // Dates et assignation - CONSERVER
  assigneeId String?
  dueDate    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siaId])
  @@index([status])
}

model TensionEdge {
  tensionId String
  tension   Tension @relation(fields: [tensionId], references: [id], onDelete: Cascade)
  edgeId    String
  edge      Edge    @relation(fields: [edgeId], references: [id], onDelete: Cascade)

  @@id([tensionId, edgeId])
}

// CONSERVER pour compatibilité
enum TensionPattern {
  SECURITY_VS_PRIVACY
  PERSONALIZATION_VS_AUTONOMY
  EFFICIENCY_VS_TRANSPARENCY
  PERFORMANCE_VS_EQUITY
  AUTOMATION_VS_RECOURSE
  PRECISION_VS_MINIMIZATION
  INNOVATION_VS_PRECAUTION
  STANDARDIZATION_VS_SINGULARITY
  SPEED_VS_REFLECTION
  EXHAUSTIVITY_VS_OBLIVION
  ACCESSIBILITY_VS_CONTROL
  PREDICTION_VS_FREEWILL
  PERSONALIZATION_VS_EQUALITY
  CONFIDENTIALITY_VS_TRACEABILITY
  WELLBEING_VS_AUTONOMY
  COLLECTIVE_VS_INDIVIDUAL
  EFFICIENCY_VS_PROTECTION
  CONTROL_VS_INNOVATION
  SOVEREIGNTY_VS_PERFORMANCE
  RESPONSIBILITY_VS_AGILITY
  PERFORMANCE_VS_SUSTAINABILITY
  LOYALTY_VS_PROFIT
  BALANCE_VS_EFFICIENCY
  SUSTAINABILITY_VS_ACCESSIBILITY
  OTHER
}

enum TensionStatus {
  DETECTED
  QUALIFIED
  VALIDATED
  CONTESTED
  ARBITRATED
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

enum RuleFamily {
  STRUCTURAL
  DATA
  DEPENDENCY
  CONTEXTUAL
  GOVERNANCE
}

// ============================================
// ARBITRAGE
// ============================================

model Arbitration {
  id        String  @id @default(cuid())
  tensionId String
  tension   Tension @relation(fields: [tensionId], references: [id], onDelete: Cascade)

  prioritizedDomain EthicalDomain?

  justificationCategory JustificationCategory?
  justificationText     String? @db.Text

  mitigationActions String[]

  revisionTriggers  RevisionTrigger[]
  revisionDate      DateTime?
  revisionCondition String?

  maturityLevel ArbitrationMaturity @default(RECOGNIZED)

  hasDisagreement        Boolean              @default(false)
  divergentPositions     DivergentPosition[]
  finalDecisionAuthority String?

  arbitratedById String?
  arbitratedBy   User?    @relation(fields: [arbitratedById], references: [id])
  arbitratedAt   DateTime @default(now())

  // CONSERVER pour compatibilité
  decision          String? @db.Text
  justification     String? @db.Text
  proportionality   String? @db.Text
  contestability    String? @db.Text
  revisionConditions String? @db.Text
  compensatoryMeasures String? @db.Text

  evidences Evidence[]
  actions   Action[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ArbitrationMaturity {
  NOT_TREATED
  RECOGNIZED
  DECIDED
  TESTED
  MONITORED
}

enum JustificationCategory {
  REGULATORY_CONSTRAINT
  USER_EXPECTATIONS
  ECONOMIC_CONSTRAINT
  TECHNICAL_CONSTRAINT
  STRATEGIC_CHOICE
  OTHER
}

enum RevisionTrigger {
  DATA_SOURCE_CHANGE
  MODEL_CHANGE
  PROVIDER_CHANGE
  NEW_USER_GROUP
  NEW_GEOGRAPHIC_SCOPE
  INCIDENT
  REGULATORY_CHANGE
  SCHEDULED_REVIEW
  DRIFT_DETECTED
}

model DivergentPosition {
  id            String @id @default(cuid())
  arbitrationId String
  arbitration   Arbitration @relation(fields: [arbitrationId], references: [id], onDelete: Cascade)

  stakeholder String
  role        String
  position    String  @db.Text

  createdAt DateTime @default(now())
}

// ============================================
// ACTIONS
// ============================================

model Action {
  id    String @id @default(cuid())
  siaId String
  sia   Sia    @relation(fields: [siaId], references: [id], onDelete: Cascade)

  tensionId     String?
  tension       Tension?     @relation(fields: [tensionId], references: [id], onDelete: SetNull)
  arbitrationId String?
  arbitration   Arbitration? @relation(fields: [arbitrationId], references: [id], onDelete: SetNull)

  title       String
  description String?  @db.Text

  actionType ActionType?
  category   ActionCategory

  targetDomain   EthicalDomain?
  expectedImpact Int?

  priority Priority @default(MEDIUM)
  effort   Effort   @default(MEDIUM)
  status   ActionStatus @default(TODO)

  // CONSERVER pour compatibilité
  estimatedImpact Json?
  checklist       Json?
  templateId      String?
  sourceRule      String?

  dueDate     DateTime?
  completedAt DateTime?

  assigneeId String?
  assignee   User?   @relation(fields: [assigneeId], references: [id])

  evidences Evidence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siaId])
  @@index([tensionId])
  @@index([status])
}

enum ActionType {
  MITIGATION
  COMPENSATION
  SURVEILLANCE
}

enum ActionCategory {
  MINIMIZATION
  TRANSPARENCY
  HUMAN_CONTROL
  RECOURSE
  TECHNICAL
  ORGANIZATIONAL
  DESIGN
  CONTRACTUAL
  DOCUMENTATION
  AUDIT
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum Effort {
  TRIVIAL
  SMALL
  MEDIUM
  LARGE
  HUGE
}

enum ActionStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELLED
}

// ============================================
// PREUVES
// ============================================

model Evidence {
  id       String @id @default(cuid())

  actionId      String?
  action        Action?      @relation(fields: [actionId], references: [id], onDelete: Cascade)
  arbitrationId String?
  arbitration   Arbitration? @relation(fields: [arbitrationId], references: [id], onDelete: Cascade)

  type     EvidenceType
  title    String
  description String?
  url      String?
  fileKey  String?
  fileName String?

  uploadedAt DateTime @default(now())
}

enum EvidenceType {
  DOCUMENT
  SCREENSHOT
  LINK
  CODE
  TEST_RESULT
  AUDIT_REPORT
  METRIC_DASHBOARD
  PROCEDURE
  OTHER
}

// ============================================
// VERSIONING
// ============================================

model Version {
  id        String @id @default(cuid())
  siaId     String
  sia       Sia    @relation(fields: [siaId], references: [id], onDelete: Cascade)

  number    Int
  label     String?
  snapshot  Json
  changelog String?  @db.Text

  // CONSERVER pour compatibilité
  vigilanceScores Json?
  globalScore     Float?
  tensionCount    Int?
  resolvedCount   Int?
  actionCount     Int?
  completedCount  Int?
  createdById     String?

  createdAt DateTime @default(now())

  @@unique([siaId, number])
  @@index([siaId])
}
